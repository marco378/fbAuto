/**
 * FB Auto - CORS Proxy Approach
 * Uses a different method to authenticate with the API
 */

// WORKING BOOKMARKLET - Copy this entire line:
javascript:(function(){if(window.fbAutoWorking){alert('FB Auto already running!');return;}window.fbAutoWorking=true;const CONFIG={apiBaseUrl:'https://fbauto-production-4368.up.railway.app/api',authToken:'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiJjbWdtMWZtbW0wMDAwcHAwMXFyOWFtMTliIiwiZW1haWwiOiJhc2RAZ21haWwuY29tIiwiaWF0IjoxNzYwMTcyNzkyLCJleHAiOjE3NjA3Nzc1OTJ9.8cMwfH1R2aXSlRYGB_dh34Exqu_nVpPILXSkJ-6s-xY',pollingInterval:30000};const log=(message,type='info')=>{const timestamp=new Date().toISOString().substr(11,8);console.log(`ðŸš€ [${timestamp}] FB Auto: ${message}`);updateStatusIndicator(message,type);};const createStatusIndicator=()=>{if(document.getElementById('fb-auto-working'))return;const indicator=document.createElement('div');indicator.id='fb-auto-working';indicator.style.cssText='position:fixed;top:10px;right:10px;background:#4CAF50;color:white;padding:12px 16px;border-radius:25px;font-size:14px;z-index:999999;box-shadow:0 4px 12px rgba(0,0,0,0.4);font-family:Arial,sans-serif;font-weight:bold;';indicator.innerHTML='ðŸš€ FB Auto: Starting...';document.body.appendChild(indicator);};const updateStatusIndicator=(message,type='info')=>{const indicator=document.getElementById('fb-auto-working');if(!indicator)return;const colors={info:'#2196F3',success:'#4CAF50',warning:'#FF9800',error:'#F44336'};const icons={info:'â„¹ï¸',success:'âœ…',warning:'âš ï¸',error:'âŒ'};indicator.style.background=colors[type]||colors.info;indicator.innerHTML=`${icons[type]||'ðŸš€'} ${message}`;};const makeAPICall=async(endpoint,options={})=>{const url=`${CONFIG.apiBaseUrl}${endpoint}`;log(`Making API call to: ${endpoint}`);const requestOptions={method:'GET',mode:'cors',credentials:'include',headers:{'Content-Type':'application/json','Authorization':`Bearer ${CONFIG.authToken}`,'Accept':'application/json'},...options};try{const response=await fetch(url,requestOptions);log(`Response status: ${response.status}`);if(!response.ok){const errorText=await response.text();log(`API Error: ${response.status} - ${errorText}`,'error');if(response.status===401){log('Authentication failed - trying alternative method','warning');return await tryAlternativeAuth(endpoint,options);}return{error:errorText,jobs:[]};}const data=await response.json();log(`API Success: ${endpoint} returned ${data.jobs?.length||0} jobs`,'success');return data;}catch(error){log(`API call failed: ${error.message}`,'error');return{error:error.message,jobs:[]};}};const tryAlternativeAuth=async(endpoint,options={})=>{log('Trying alternative authentication method','info');const proxyUrl=`${CONFIG.apiBaseUrl}${endpoint}?token=${encodeURIComponent(CONFIG.authToken)}`;try{const response=await fetch(proxyUrl,{method:options.method||'GET',headers:{'Content-Type':'application/json'},body:options.body});if(!response.ok){log(`Alternative auth also failed: ${response.status}`,'error');return{error:'Authentication failed',jobs:[]};}const data=await response.json();log('Alternative auth successful','success');return data;}catch(error){log(`Alternative auth failed: ${error.message}`,'error');return{error:error.message,jobs:[]};}};const fetchPendingJobs=async()=>{const data=await makeAPICall('/jobs/client-automation');return data.jobs||[];};const updateJobStatus=async(jobId,groupName,status,postUrl=null,error=null)=>{try{await makeAPICall(`/jobs/${jobId}/update-posting-status`,{method:'POST',body:JSON.stringify({facebookGroup:groupName,status,postUrl,error})});log(`Status updated: ${groupName} = ${status}`);}catch(error){log(`Failed to update status: ${error.message}`,'error');}};const sleep=ms=>new Promise(resolve=>setTimeout(resolve,ms));const isVisible=element=>{if(!element)return false;const style=window.getComputedStyle(element);return style.display!=='none'&&style.visibility!=='hidden'&&style.opacity!=='0'&&element.offsetWidth>0&&element.offsetHeight>0;};const findPostComposer=()=>{const selectors=['[data-testid="status-attachment-mentions-input"]','[role="textbox"][data-testid]','[contenteditable="true"][role="textbox"]','textarea[placeholder*="mind"]','[contenteditable="true"]'];for(const selector of selectors){const element=document.querySelector(selector);if(element&&isVisible(element)){log(`Found composer: ${selector}`);return element;}}log('No composer found','warning');return null;};const findPostButton=()=>{const selectors=['[data-testid="react-composer-post-button"]','[aria-label="Post"]','button[type="submit"]'];for(const selector of selectors){const elements=document.querySelectorAll(selector);for(const element of elements){if(element.textContent.toLowerCase().includes('post')&&isVisible(element)){log(`Found post button: ${selector}`);return element;}}}log('No post button found','warning');return null;};const formatJobPost=job=>{return`ðŸ”¥ ${job.title}\nðŸ¢ ${job.company}\n\nðŸ“ Location: ${job.location}\nðŸ’¼ Job Type: ${job.jobType}\n${job.salaryRange?`ðŸ’° Salary: ${job.salaryRange}\n`:''}\nðŸ“ Description:\n${job.description.trim()}\n${job.requirements?.length?`\nâœ… Requirements:\n${job.requirements.map(r=>`â€¢ ${r.trim()}`).join('\n')}\n`:''}${job.responsibilities?.length?`\nðŸŽ¯ Key Responsibilities:\n${job.responsibilities.map(r=>`â€¢ ${r.trim()}`).join('\n')}\n`:''}\nðŸ’¬ Interested? Comment below or send me a message!\n\n#hiring #jobs #career #opportunity`;};const postToGroup=async(job,groupName)=>{try{log(`Posting ${job.title} to ${groupName}...`,'info');updateStatusIndicator(`Posting to ${groupName}...`,'info');if(!window.location.hostname.includes('facebook.com')){throw new Error('Please navigate to Facebook.com first');}await sleep(1000);let composer=findPostComposer();if(!composer){log('Trying to open composer...','info');const prompts=document.querySelectorAll('[placeholder*="mind"],[data-testid*="composer"]');for(const prompt of prompts){if(isVisible(prompt)){prompt.click();await sleep(2000);composer=findPostComposer();if(composer)break;}}}if(!composer){throw new Error('Cannot find post composer. Please click "What\'s on your mind?" first.');}const postContent=formatJobPost(job);composer.focus();await sleep(500);if(composer.tagName==='TEXTAREA'){composer.value=postContent;composer.dispatchEvent(new Event('input',{bubbles:true}));composer.dispatchEvent(new Event('change',{bubbles:true}));}else{composer.innerHTML=postContent.replace(/\n/g,'<br>');composer.dispatchEvent(new Event('input',{bubbles:true}));composer.dispatchEvent(new Event('paste',{bubbles:true}));}await sleep(3000);const userConfirmed=confirm(`Ready to post job "${job.title}" to group "${groupName}"?\n\nClick OK to post, Cancel to skip.`);if(!userConfirmed){throw new Error('User cancelled posting');}const postButton=findPostButton();if(!postButton){const manualPost=confirm('Cannot find Post button automatically.\n\nPlease click POST manually, then click OK here.\n\nClick OK after posting, Cancel to mark as failed.');if(!manualPost){throw new Error('Manual posting cancelled');}log('User completed manual posting','success');}else{log('Clicking post button','info');postButton.click();}await sleep(3000);log(`âœ… Posted to ${groupName}`,'success');updateStatusIndicator(`âœ… Posted to ${groupName}`,'success');await updateJobStatus(job.id,groupName,'SUCCESS',window.location.href);return{success:true};}catch(error){log(`âŒ Failed: ${groupName} - ${error.message}`,'error');updateStatusIndicator(`âŒ Failed: ${groupName}`,'error');await updateJobStatus(job.id,groupName,'FAILED',null,error.message);return{success:false,error:error.message};}};const processJobs=async(jobs)=>{if(!jobs||jobs.length===0){updateStatusIndicator('No jobs found','info');return{processed:0,successful:0};}let successful=0;const totalPosts=jobs.reduce((acc,job)=>acc+job.pendingGroups.length,0);log(`Processing ${jobs.length} jobs (${totalPosts} posts)`,'info');updateStatusIndicator(`Processing ${jobs.length} jobs...`,'info');for(const job of jobs){log(`Processing job: ${job.title}`,'info');for(const groupName of job.pendingGroups){const result=await postToGroup(job,groupName);if(result.success)successful++;await sleep(8000);}}const successRate=totalPosts>0?((successful/totalPosts)*100).toFixed(1):0;log(`Completed: ${successful}/${totalPosts} posts (${successRate}% success)`,'success');updateStatusIndicator(`Done: ${successful}/${totalPosts} posted`,'success');return{processed:totalPosts,successful};};const runOnce=async()=>{try{updateStatusIndicator('Checking for jobs...','info');const jobs=await fetchPendingJobs();if(jobs&&jobs.length>0){log(`Found ${jobs.length} jobs ready for posting`,'success');await processJobs(jobs);updateStatusIndicator('Automation complete!','success');}else{log('No pending jobs found');updateStatusIndicator('No jobs to post','info');}}catch(error){log(`Automation error: ${error.message}`,'error');updateStatusIndicator('Automation failed','error');}setTimeout(()=>{window.fbAutoWorking=false;},5000);};const startAutomation=()=>{log('ðŸš€ FB Auto started (one-time run)','success');createStatusIndicator();if(window.location.hostname.includes('facebook.com')){log('On Facebook - starting automation','success');runOnce();}else{updateStatusIndicator('Please go to Facebook.com','warning');log('Not on Facebook - please navigate to facebook.com','warning');}};startAutomation();})();